import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

class LocalizationService {
  static const String _languageKey = 'selected_language';
  
  // Supported languages
  static const Map<String, LanguageModel> supportedLanguages = {
    'en': LanguageModel(
      code: 'en',
      name: 'English',
      nativeName: 'English',
      flag: 'üá¨üáß',
    ),
    'hi': LanguageModel(
      code: 'hi',
      name: 'Hindi',
      nativeName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',
      flag: 'üáÆüá≥',
    ),
    'ta': LanguageModel(
      code: 'ta',
      name: 'Tamil',
      nativeName: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',
      flag: 'üáÆüá≥',
    ),
    'te': LanguageModel(
      code: 'te',
      name: 'Telugu',
      nativeName: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
      flag: 'üáÆüá≥',
    ),
    'kn': LanguageModel(
      code: 'kn',
      name: 'Kannada',
      nativeName: '‡≤ï‡≤®‡≥ç‡≤®‡≤°',
      flag: 'üáÆüá≥',
    ),
    'ml': LanguageModel(
      code: 'ml',
      name: 'Malayalam',
      nativeName: '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç',
      flag: 'üáÆüá≥',
    ),
    'mr': LanguageModel(
      code: 'mr',
      name: 'Marathi',
      nativeName: '‡§Æ‡§∞‡§æ‡§†‡•Ä',
      flag: 'üáÆüá≥',
    ),
    'gu': LanguageModel(
      code: 'gu',
      name: 'Gujarati',
      nativeName: '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä',
      flag: 'üáÆüá≥',
    ),
    'pa': LanguageModel(
      code: 'pa',
      name: 'Punjabi',
      nativeName: '‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä',
      flag: 'üáÆüá≥',
    ),
    'bn': LanguageModel(
      code: 'bn',
      name: 'Bengali',
      nativeName: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ',
      flag: 'üáÆüá≥',
    ),
  };

  // Get current language
  static Future<String> getCurrentLanguage() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_languageKey) ?? 'en';
  }

  // Set language
  static Future<bool> setLanguage(String languageCode) async {
    if (!supportedLanguages.containsKey(languageCode)) {
      return false;
    }
    final prefs = await SharedPreferences.getInstance();
    return await prefs.setString(_languageKey, languageCode);
  }

  // Get locale from language code
  static Locale getLocale(String languageCode) {
    return Locale(languageCode);
  }

  // Get current locale
  static Future<Locale> getCurrentLocale() async {
    final languageCode = await getCurrentLanguage();
    return getLocale(languageCode);
  }

  // Get supported locales
  static List<Locale> getSupportedLocales() {
    return supportedLanguages.keys.map((code) => Locale(code)).toList();
  }
}

// Language Model
class LanguageModel {
  final String code;
  final String name;
  final String nativeName;
  final String flag;

  const LanguageModel({
    required this.code,
    required this.name,
    required this.nativeName,
    required this.flag,
  });
}

// App Localizations Delegate
class AppLocalizationsDelegate extends LocalizationsDelegate<AppLocalizations> {
  const AppLocalizationsDelegate();

  @override
  bool isSupported(Locale locale) {
    return LocalizationService.supportedLanguages.containsKey(locale.languageCode);
  }

  @override
  Future<AppLocalizations> load(Locale locale) async {
    return AppLocalizations(locale);
  }

  @override
  bool shouldReload(AppLocalizationsDelegate old) => false;
}

// App Localizations
class AppLocalizations {
  final Locale locale;
  late Map<String, String> _localizedStrings;

  AppLocalizations(this.locale);

  static AppLocalizations? of(BuildContext context) {
    return Localizations.of<AppLocalizations>(context, AppLocalizations);
  }

  Future<bool> load() async {
    _localizedStrings = _translations[locale.languageCode] ?? _translations['en']!;
    return true;
  }

  String translate(String key) {
    return _localizedStrings[key] ?? key;
  }

  // Translations database
  static final Map<String, Map<String, String>> _translations = {
    'en': {
      // Common
      'app_name': 'AGRIVIGIL',
      'welcome': 'Welcome',
      'login': 'Login',
      'logout': 'Logout',
      'submit': 'Submit',
      'cancel': 'Cancel',
      'save': 'Save',
      'delete': 'Delete',
      'edit': 'Edit',
      'search': 'Search',
      'filter': 'Filter',
      'export': 'Export',
      'back': 'Back',
      'next': 'Next',
      'previous': 'Previous',
      'loading': 'Loading...',
      'error': 'Error',
      'success': 'Success',
      'warning': 'Warning',
      'info': 'Information',
      'yes': 'Yes',
      'no': 'No',
      'confirm': 'Confirm',
      'close': 'Close',
      
      // Authentication
      'email': 'Email',
      'password': 'Password',
      'forgot_password': 'Forgot Password?',
      'sign_up': 'Sign Up',
      'sign_in': 'Sign In',
      'remember_me': 'Remember Me',
      
      // Dashboard
      'dashboard': 'Dashboard',
      'overview': 'Overview',
      'statistics': 'Statistics',
      'recent_activities': 'Recent Activities',
      'notifications': 'Notifications',
      
      // Inspections
      'inspections': 'Inspections',
      'new_inspection': 'New Inspection',
      'inspection_details': 'Inspection Details',
      'inspection_code': 'Inspection Code',
      'location': 'Location',
      'dealer_name': 'Dealer Name',
      'execution_date': 'Execution Date',
      'status': 'Status',
      'violation_found': 'Violation Found',
      'remarks': 'Remarks',
      
      // Seizures
      'seizures': 'Seizures',
      'new_seizure': 'New Seizure',
      'seizure_details': 'Seizure Details',
      'seizure_code': 'Seizure Code',
      'seizure_date': 'Seizure Date',
      'total_quantity': 'Total Quantity',
      'estimated_value': 'Estimated Value',
      'reason': 'Reason',
      
      // Lab Samples
      'lab_samples': 'Lab Samples',
      'new_sample': 'New Sample',
      'sample_details': 'Sample Details',
      'sample_code': 'Sample Code',
      'sample_type': 'Sample Type',
      'collection_date': 'Collection Date',
      'test_date': 'Test Date',
      'test_result': 'Test Result',
      'analyst_name': 'Analyst Name',
      
      // FIR Cases
      'fir_cases': 'FIR Cases',
      'new_fir': 'New FIR',
      'fir_details': 'FIR Details',
      'fir_number': 'FIR Number',
      'case_title': 'Case Title',
      'case_type': 'Case Type',
      'accused_name': 'Accused Name',
      'police_station': 'Police Station',
      'filed_date': 'Filed Date',
      
      // Forms
      'forms': 'Forms',
      'form_submissions': 'Form Submissions',
      'new_submission': 'New Submission',
      'farmer_name': 'Farmer Name',
      'farmer_contact': 'Farmer Contact',
      'submission_date': 'Submission Date',
      
      // Settings
      'settings': 'Settings',
      'profile': 'Profile',
      'language': 'Language',
      'theme': 'Theme',
      'notifications_settings': 'Notification Settings',
      'privacy': 'Privacy',
      'about': 'About',
      'help': 'Help',
      
      // Messages
      'login_success': 'Login successful',
      'login_failed': 'Login failed. Please check your credentials.',
      'logout_success': 'Logged out successfully',
      'save_success': 'Saved successfully',
      'delete_success': 'Deleted successfully',
      'update_success': 'Updated successfully',
      'operation_failed': 'Operation failed. Please try again.',
      'network_error': 'Network error. Please check your connection.',
      'permission_denied': 'Permission denied',
      'session_expired': 'Session expired. Please login again.',
    },
    
    'hi': {
      // Common
      'app_name': '‡§è‡§ó‡•ç‡§∞‡•Ä‡§µ‡§ø‡§ú‡§ø‡§≤',
      'welcome': '‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à',
      'login': '‡§≤‡•â‡§ó ‡§á‡§®',
      'logout': '‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü',
      'submit': '‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç',
      'cancel': '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
      'save': '‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
      'delete': '‡§π‡§ü‡§æ‡§è‡§Ç',
      'edit': '‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç',
      'search': '‡§ñ‡•ã‡§ú‡•á‡§Ç',
      'filter': '‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞',
      'export': '‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§',
      'back': '‡§µ‡§æ‡§™‡§∏',
      'next': '‡§Ö‡§ó‡§≤‡§æ',
      'previous': '‡§™‡§ø‡§õ‡§≤‡§æ',
      'loading': '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
      'error': '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',
      'success': '‡§∏‡§´‡§≤‡§§‡§æ',
      'warning': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä',
      'info': '‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä',
      'yes': '‡§π‡§æ‡§Å',
      'no': '‡§®‡§π‡•Ä‡§Ç',
      'confirm': '‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç',
      'close': '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
      
      // Authentication
      'email': '‡§à‡§Æ‡•á‡§≤',
      'password': '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
      'forgot_password': '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡•Ç‡§≤ ‡§ó‡§è?',
      'sign_up': '‡§∏‡§æ‡§á‡§® ‡§Ö‡§™',
      'sign_in': '‡§∏‡§æ‡§á‡§® ‡§á‡§®',
      'remember_me': '‡§Æ‡•Å‡§ù‡•á ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç',
      
      // Dashboard
      'dashboard': '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
      'overview': '‡§Ö‡§µ‡§≤‡•ã‡§ï‡§®',
      'statistics': '‡§Ü‡§Ç‡§ï‡§°‡§º‡•á',
      'recent_activities': '‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§Ø‡§æ‡§Ç',
      'notifications': '‡§∏‡•Ç‡§ö‡§®‡§æ‡§è‡§Ç',
      
      // Inspections
      'inspections': '‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£',
      'new_inspection': '‡§®‡§Ø‡§æ ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£',
      'inspection_details': '‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§µ‡§ø‡§µ‡§∞‡§£',
      'inspection_code': '‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡•ã‡§°',
      'location': '‡§∏‡•ç‡§•‡§æ‡§®',
      'dealer_name': '‡§°‡•Ä‡§≤‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ',
      'execution_date': '‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§§‡§ø‡§•‡§ø',
      'status': '‡§∏‡•ç‡§•‡§ø‡§§‡§ø',
      'violation_found': '‡§â‡§≤‡•ç‡§≤‡§Ç‡§ò‡§® ‡§™‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ',
      'remarks': '‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Ç',
      
      // Add more Hindi translations...
    },
    
    'ta': {
      // Common
      'app_name': '‡ÆÖ‡Æï‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡Æú‡Æø‡Æ≤‡Øç',
      'welcome': '‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç',
      'login': '‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà',
      'logout': '‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ',
      'submit': '‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø',
      'cancel': '‡Æ∞‡Æ§‡Øç‡Æ§‡ØÅ',
      'save': '‡Æö‡Øá‡ÆÆ‡Æø',
      'delete': '‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ',
      'edit': '‡Æ§‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ',
      'search': '‡Æ§‡Øá‡Æü‡ØÅ',
      'filter': '‡Æµ‡Æü‡Æø‡Æï‡Æü‡Øç‡Æü‡Æø',
      'export': '‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Æ§‡Æø',
      'back': '‡Æ™‡Æø‡Æ©‡Øç',
      'next': '‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ',
      'previous': '‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ',
      'loading': '‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...',
      'error': '‡Æ™‡Æø‡Æ¥‡Øà',
      'success': '‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø',
      'warning': '‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà',
      'info': '‡Æ§‡Æï‡Æµ‡Æ≤‡Øç',
      'yes': '‡ÆÜ‡ÆÆ‡Øç',
      'no': '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà',
      'confirm': '‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ',
      'close': '‡ÆÆ‡ØÇ‡Æü‡ØÅ',
      
      // Add more Tamil translations...
    },
    
    // Add translations for other languages (te, kn, ml, mr, gu, pa, bn)...
  };
}

// Language Selector Widget
class LanguageSelectorWidget extends StatefulWidget {
  final Function(String)? onLanguageChanged;
  
  const LanguageSelectorWidget({
    Key? key,
    this.onLanguageChanged,
  }) : super(key: key);

  @override
  State<LanguageSelectorWidget> createState() => _LanguageSelectorWidgetState();
}

class _LanguageSelectorWidgetState extends State<LanguageSelectorWidget> {
  String _currentLanguage = 'en';

  @override
  void initState() {
    super.initState();
    _loadCurrentLanguage();
  }

  Future<void> _loadCurrentLanguage() async {
    final language = await LocalizationService.getCurrentLanguage();
    setState(() {
      _currentLanguage = language;
    });
  }

  @override
  Widget build(BuildContext context) {
    return PopupMenuButton<String>(
      icon: Row(
        children: [
          Text(
            LocalizationService.supportedLanguages[_currentLanguage]!.flag,
            style: const TextStyle(fontSize: 20),
          ),
          const SizedBox(width: 4),
          const Icon(Icons.arrow_drop_down),
        ],
      ),
      onSelected: (String languageCode) async {
        if (languageCode != _currentLanguage) {
          final success = await LocalizationService.setLanguage(languageCode);
          if (success) {
            setState(() {
              _currentLanguage = languageCode;
            });
            widget.onLanguageChanged?.call(languageCode);
          }
        }
      },
      itemBuilder: (BuildContext context) {
        return LocalizationService.supportedLanguages.entries.map((entry) {
          final language = entry.value;
          return PopupMenuItem<String>(
            value: entry.key,
            child: Row(
              children: [
                Text(
                  language.flag,
                  style: const TextStyle(fontSize: 20),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      language.name,
                      style: const TextStyle(fontWeight: FontWeight.w500),
                    ),
                    Text(
                      language.nativeName,
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.grey[600],
                      ),
                    ),
                  ],
                ),
                if (_currentLanguage == entry.key) ...[
                  const Spacer(),
                  const Icon(
                    Icons.check,
                    color: Colors.green,
                    size: 20,
                  ),
                ],
              ],
            ),
          );
        }).toList();
      },
    );
  }
}

// Extension for easy translation
extension TranslationExtension on BuildContext {
  String tr(String key) {
    return AppLocalizations.of(this)?.translate(key) ?? key;
  }
}
